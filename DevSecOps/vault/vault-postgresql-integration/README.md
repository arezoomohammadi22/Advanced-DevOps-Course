
# Vault Integration with PostgreSQL

This README outlines the steps to configure HashiCorp Vault to manage dynamic credentials for PostgreSQL. It also includes the necessary commands to verify the configuration and test the credentials. Additionally, the PostgreSQL Kubernetes manifests are included for reference.

## Prerequisites
1. PostgreSQL is running on your Kubernetes cluster, and you have access to it.
2. Vault is installed and running.
3. You have Kubernetes access to manage your pods and services.

## 1. Enable the PostgreSQL Secrets Engine in Vault

To enable the PostgreSQL secrets engine in Vault, run the following command:

```bash
vault secrets enable database
```

This command enables the PostgreSQL secrets engine, which will allow Vault to manage database credentials.

## 2. Configure PostgreSQL in Vault

Next, configure Vault to connect to your PostgreSQL instance. Replace `password` with your PostgreSQL password and adjust the `postgres-svc` service name as needed.

```bash
vault write database/config/postgres     plugin_name=postgresql-database-plugin     allowed_roles="readonly, readwrite"     connection_url="postgresql://postgres:password@postgres-svc:5432/mydb?sslmode=disable"
```

- `connection_url`: This is the connection string that Vault will use to connect to your PostgreSQL database. Make sure the `password` is correct and `postgres-svc` is the service name.
- `allowed_roles`: The roles Vault can generate credentials for. In this case, `readonly` and `readwrite`.

## 3. Create a Role in Vault

Now, define the role in Vault that will create dynamic credentials for PostgreSQL. This role will allow Vault to generate users with `readwrite` access to the `mydb` database.

```bash
vault write database/roles/readwrite     db_name=postgres     creation_statements="CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE NOREPLICATION; GRANT ALL PRIVILEGES ON DATABASE mydb TO "{{name}}""     default_ttl="1h"     max_ttl="24h"
```

### Explanation:
- `creation_statements`: The SQL statement that creates a new user with the dynamic username and password generated by Vault. The user is granted `ALL PRIVILEGES` on the `mydb` database.
- `default_ttl`: The default time-to-live (TTL) for the credentials. These credentials will expire after this duration.
- `max_ttl`: The maximum TTL for the credentials.

## 4. Generate Credentials from Vault

To generate dynamic credentials using Vault, run the following command:

```bash
vault read database/creds/readwrite
```

This will generate a `username` and `password`, which you can use to connect to PostgreSQL. The output will look like this:

```json
Key                Value
---                -----
username           vault_XXXX
password           XXXXXXXXXXXXX
lease_id           database/creds/readwrite/XXXX
lease_duration     1h
lease_renewable    true
```

## 5. Test the PostgreSQL Credentials

Use the generated `username` and `password` to connect to PostgreSQL. Run the following command from within a Kubernetes pod:

```bash
kubectl run -it --rm --image=postgres --restart=Never --command -- psql -h postgres-svc -U vault_XXXX -d mydb
```

Replace `vault_XXXX` with the username returned by Vault and provide the password when prompted.

Alternatively, if you have access from outside the Kubernetes cluster, you can use the following command:

```bash
psql -h <postgres-svc-ip> -U vault_XXXX -d mydb
```

### Expected Outcome:
- If the credentials are correct, you should be connected to the `mydb` database with `readwrite` access.

## 6. Revoke the Credentials

Once you are done testing, you can revoke the credentials by running:

```bash
vault lease revoke <lease_id>
```

Replace `<lease_id>` with the lease ID that was returned when you generated the credentials.

## 7. Verify PostgreSQL Roles

To verify the roles and the creation of the PostgreSQL user, you can connect to your PostgreSQL database using a superuser account (like `postgres`):

```bash
psql -h postgres-svc -U postgres -d mydb
```

Once inside the `psql` shell, you can check the created roles by running:

```sql
\du
```

This will list all the roles in PostgreSQL. You should see the dynamically created role (e.g., `vault_XXXX`).

## 8. PostgreSQL Deployment Manifest

Below is the Kubernetes deployment manifest for PostgreSQL.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      nodeSelector:
        node-role.kubernetes.io/master: "true"  # Ensures the pod runs on k8s-master node
      containers:
      - name: postgres
        image: postgres:15
        env:
        - name: POSTGRES_DB
          value: "mydb"
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          value: "password"  # Change this to a secure password
        ports:
        - containerPort: 5432
```

## 9. PostgreSQL Service Manifest

Here is the Kubernetes service manifest for exposing the PostgreSQL database:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres-svc
spec:
  selector:
    app: postgres
  ports:
    - protocol: TCP
      port: 5432
      targetPort: 5432
  clusterIP: None  # For StatefulSet, use None, otherwise, the default ClusterIP is fine.
```

## Conclusion

These steps will allow you to configure Vault to manage PostgreSQL credentials dynamically, test the integration, and verify the created roles within PostgreSQL.

Make sure to delete the generated credentials and revoke the leases when you're done testing.
