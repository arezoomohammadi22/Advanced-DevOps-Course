input {
  # همون ورودی فعلیِ syslog/nginx از طریق TCP
  tcp {
    host  => "0.0.0.0"
    port  => 5000
    codec => plain
    type  => "syslog_raw"
  }

  # Apache access logs (یک یا چند vhost)
  file {
    path => ["/var/log/apache2/*access.log", "/var/log/httpd/*access_log"]
    sincedb_path   => "/home/arezoo/sincedb_apache_access"    
    start_position => "beginning"            # برای تست اولیه: از ابتدای فایل بخواند
    type => "apache_access"
    mode => "tail"
  }

}

filter {
  #####################################################################
  # 1) Nginx via syslog_raw (همانی که داشتی)
  #####################################################################
  if [type] == "syslog_raw" {
    grok {
      match => {
        "message" => "%{GREEDYDATA:_hdr}\s%{IP:client_ip}\s-\s-\s\[%{HTTPDATE:nginx_time}\]\s\"%{WORD:http_method}\s%{URIPATHPARAM:url_path}\sHTTP/%{NUMBER:http_version}\"\s%{NUMBER:status}\s%{NUMBER:bytes}\s\"%{DATA:referrer}\"\s\"%{DATA:user_agent}\""
      }
    }

    date {
      match  => ["nginx_time", "dd/MMM/YYYY:HH:mm:ss Z"]
      locale => "en"
    }

    mutate {
      gsub => [
        "bytes", "^-$", "0",
        "referrer", "^-$", ""
      ]
      convert => {
        "status"       => "integer"
        "bytes"        => "integer"
        "http_version" => "float"
      }
      lowercase => ["http_method"]
      remove_field => ["_hdr","message"]
    }
  }

  #####################################################################
  # 2) Apache access logs from files
  #####################################################################
  else if [type] == "apache_access" {
    # الگوی استاندارد لاگ اَپَچی (combined)
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
      tag_on_failure => ["_grok_apache_access_failure"]
    }

    # زمان 'timestamp' در COMBINEDAPACHELOG مثل [12/Nov/2025:14:20:26 +0330]
    date {
      match  => ["timestamp", "dd/MMM/YYYY:HH:mm:ss Z"]
      locale => "en"
    }

    mutate {
      gsub => [ "referrer", "^-$", "" ]
      convert => {
        "bytes"  => "integer"
        "response" => "integer"
      }
      # همسان‌سازی نام‌ها با الگوی nginx (اختیاری)
      rename => { "response" => "status" }
      rename => { "request"  => "http_request" }
      remove_field => ["message"]
    }
  }

  #####################################################################
  # 3) (اختیاری) Apache error logs — در صورت نیاز فعالش کن
  #####################################################################
  # else if [type] == "apache_error" {
  #   grok {
  #     match => {
  #       "message" => "\[%{HTTPDATE:apache_error_time}\]\s+\[%{LOGLEVEL:loglevel}\](?:\s+\[pid %{NUMBER:pid}(?::%{NUMBER:tid})?\])?(?:\s+\[client %{IPORHOST:client}\])?\s%{GREEDYDATA:error_message}"
  #     }
  #     tag_on_failure => ["_grok_apache_error_failure"]
  #   }
  #   date {
  #     match  => ["apache_error_time", "dd/MMM/YYYY:HH:mm:ss Z"]
  #     locale => "en"
  #   }
  #   mutate {
  #     add_field => { "[@metadata][index]" => "apache-error-%{+YYYY.MM.dd}" }
  #     remove_field => ["message"]
  #   }
  # }
}

output {
  if [type] == "syslog_raw" {
    elasticsearch {
      hosts => ["https://10.211.55.63:9200"]
      index => "syslog-nginx-grok-%{+YYYY.MM.dd}"
      ssl_verification_mode => none
      ssl_enabled => true
      ssl_certificate_authorities => ["/home/arezoo/cert/cacert.pem"]
      user => "${ES_USER}"
      password => "${ES_PASSWORD}"
    }
  } else if [type] == "apache_access" {
    elasticsearch {
      hosts => ["https://10.211.55.63:9200"]
      index => "apache-access-%{+YYYY.MM.dd}"
      ssl_verification_mode => none
      ssl_enabled => true
      ssl_certificate_authorities => ["/home/arezoo/cert/cacert.pem"]
      user => "${ES_USER}"
      password => "${ES_PASSWORD}"
    }
  }
}
